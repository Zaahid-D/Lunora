<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lunora</title>
  <meta name="description" content="Lunora: Your Mental-Health Companion" />
  <style>
    :root{
      --bg:#7aa6ff; --bg2:#4c67b7; --bg3:#054ea7;
      --ac:#5bc0eb; --ac2:#7aa6ff; --txt:#eaf2ff; --muted:#b6c4e1;
      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --glass: rgba(255,255,255,.08); --border: 1px solid rgba(255,255,255,.10);
      --radius: 18px; --shadow: 0 10px 30px rgba(7, 12, 26, .45);
      --journal-bg: #fffaf0; --journal-txt: #3a3a3a; --journal-border: #d4b483;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Helvetica, Arial;
      color:var(--txt);
      background: radial-gradient(1200px 700px at 20% -10%, #1e2a52 0%, transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, #163058 0%, transparent 60%),
                  linear-gradient(160deg, var(--bg), var(--bg2));
      background-attachment: fixed;
    }
    a{color:inherit}
    .container{max-width:1160px; margin:0 auto; padding:22px}

    /* ===== Top Navigation ===== */
    header{position:sticky; top:0; z-index:60; backdrop-filter: blur(8px);
      background: linear-gradient(180deg, rgba(6,12,26,.78), rgba(6,12,26,.30)); border-bottom:var(--border)}
    .nav{display:flex; align-items:center; justify-content:space-between; gap:16px}
    .brand{display:flex; align-items:center; gap:12px; text-decoration:none}
    .logo{width:44px; height:44px; border-radius:12px; display:grid; place-items:center; color:#0b1225; font-weight:800;
      background: conic-gradient(from 210deg, var(--ac), #7ad3ff, var(--ac2), var(--ac))}
    .brand span{font-weight:800; letter-spacing:.5px}

    .navlinks{display:flex; gap:8px; align-items:center; justify-content:center; flex:1}
    .navitem{border:none; border-radius:12px; padding:10px 12px; cursor:pointer; color:var(--txt); background:transparent; position:relative; font-weight:700}
    .navitem:hover{background:rgba(255,255,255,.06)}
    .navitem.active::after{content:""; position:absolute; left:10px; right:10px; bottom:-8px; height:3px; border-radius:999px; background:linear-gradient(90deg, var(--ac), var(--ac2))}

    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .btn{border:none; padding:10px 14px; border-radius:12px; cursor:pointer; color:#08101f; font-weight:700}
    .btn.primary{background:linear-gradient(180deg, var(--ac), var(--ac2))}
    .btn.ghost{background:rgba(255,255,255,.1); color:var(--txt); border:var(--border)}

    /* Navbar logo styling */
    .logo img {
      height: 40px;           /* default height */
      width: auto;            /* maintain aspect ratio */
      display: block;
      margin-right: 10px;     /* space between logo and text */
    }

    /* Optional: make it smaller on mobile */
    @media (max-width: 600px) {
      .logo img {
        height: 30px;
        margin-right: 5px;
      }
    }
    /* ===== Router ===== */
    [data-page]{display:none}
    [data-page].active{display:block}

    /* ===== Layout Components ===== */
    .card{background:var(--glass); border:var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
    .p16{padding:16px} .p20{padding:20px} .p24{padding:24px}
    .grid{display:grid; gap:18px} .grid.cols-2{grid-template-columns:repeat(2,1fr)} .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .tile{padding:18px; border-radius:16px; background:rgba(255,255,255,.06); border:var(--border); cursor:pointer; transition:transform .18s ease, background .2s ease}
    .tile:hover{transform: translateY(-2px); background:rgba(255,255,255,.10)}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:rgba(91,192,235,.18); color:#dff3ff; border:1px solid rgba(91,192,235,.35); font-weight:700}
    .headline{font-size:34px; line-height:1.1; margin:0 0 8px}
    .sub{color:var(--muted); margin:0 0 12px}
    .meta{font-size:12px; color:var(--muted)}

    /* ===== Dashboard ===== */
    .hero{display:grid; grid-template-columns:1.1fr .9fr; gap:22px; align-items:stretch; padding:26px 0}
    .stats{display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:12px}
    .stat{padding:12px; border-radius:14px; background:rgba(255,255,255,.06); border:var(--border); text-align:center}
    .stat .v{font-size:22px; font-weight:800}
    .mood-emoji{font-size:28px}
    .spark{width:100%; height:48px}

    /* Forms */
    .form-row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .input{padding:12px; border-radius:12px; border:var(--border); background:rgba(255,255,255,.06); color:var(--txt)}
    .journal-area{width:100%; min-height:160px; resize:vertical; background:rgba(255,255,255,.06); color:var(--txt); border:var(--border); border-radius:14px; padding:12px; outline:none}

    /* Avatars */
    .avatar{width:90px; height:90px; border-radius:20px; background:rgba(255,255,255,.1); display:grid; place-items:center; overflow:hidden; border:var(--border)}
    .avatar img{width:100%; height:100%; object-fit:cover}

    /* Chips / Quests */
    .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.08); border:var(--border); font-size:12px}
    .quest{display:flex; align-items:flex-start; gap:10px; padding:10px; background:rgba(255,255,255,.06); border:var(--border); border-radius:12px}

    /* SOS */
    .sos-banner{padding:12px; border-radius:12px; border:var(--border); background:linear-gradient(180deg, rgba(239,68,68,.12), rgba(239,68,68,.06)); color:#ffdede}

    /* Modal */
    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(5,10,20,.55); backdrop-filter: blur(6px); z-index:100}
    .modal.active{display:grid}
    .modal .panel{width:min(600px, 92vw)}

    /* Animations */
    .fade-in{animation:fade .6s ease both}
    @keyframes fade{from{opacity:0; transform: translateY(6px)} to{opacity:1; transform:none}}
    .pulse{animation:pulse 2s ease-in-out infinite}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(91,192,235,.5)} 50%{box-shadow:0 0 0 10px rgba(91,192,235,0)}}

    /* Responsive */
    @media (max-width:980px){ .hero{grid-template-columns:1fr} .grid.cols-3{grid-template-columns:1fr} .grid.cols-2{grid-template-columns:1fr} .stats{grid-template-columns:1fr 1fr} .navlinks{display:none} }

    footer{padding:28px 0; color:var(--muted); text-align:center; font-size:12px}

    /* Confetti */
    .confetti{position:fixed; inset:0; pointer-events:none; z-index:120; font-size:22px}

    /* Tooltips */
    .hint{position:absolute; background:#0f1b3e; border:var(--border); color:var(--txt); padding:8px 10px; border-radius:10px; font-size:12px; box-shadow:var(--shadow)}
    
    /* ===== NEW STYLES ===== */
    /* Journal Book Design */
    .journal-book {
      background: var(--journal-bg);
      color: var(--journal-txt);
      border: 1px solid var(--journal-border);
      border-radius: 8px;
      padding: 20px;
      min-height: 400px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      position: relative;
      font-family: 'Georgia', serif;
    }
    .journal-book::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 10px;
      background: linear-gradient(to right, rgba(0,0,0,0.1), transparent);
      border-radius: 8px 0 0 8px;
    }
    .journal-book textarea {
      background: transparent;
      border: none;
      color: var(--journal-txt);
      font-size: 16px;
      line-height: 1.6;
      width: 100%;
      min-height: 300px;
      padding: 10px;
      font-family: 'Georgia', serif;
    }
    .journal-book textarea:focus {
      outline: none;
    }
    .journal-toolbar {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      align-items: center;
    }
    .speech-btn {
      background: var(--ac);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      font-size: 18px;
    }
    .speech-btn.recording {
      animation: pulse 1.5s infinite;
      background: var(--bad);
    }
    
    /* Journal Archive */
    .journal-archive {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .journal-entry-card {
      background: var(--journal-bg);
      color: var(--journal-txt);
      border: 1px solid var(--journal-border);
      border-radius: 8px;
      padding: 15px;
      height: 150px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .journal-entry-card:hover {
      transform: translateY(-5px);
    }
    .journal-entry-card h4 {
      margin: 0 0 8px 0;
      color: #5a3e1f;
      border-bottom: 1px solid #d4b483;
      padding-bottom: 5px;
    }
    .journal-entry-card p {
      margin: 0;
      font-size: 14px;
      display: -webkit-box;
      -webkit-line-clamp: 4;
      line-clamp: 4;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    /* Chatbot Styles */
    .chatbot-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    .chatbot-toggle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--ac), var(--ac2));
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chatbot-window {
      position: absolute;
      bottom: 70px;
      right: 0;
      width: 350px;
      height: 450px;
      background: rgba(12, 20, 40, 0.95);
      border-radius: 18px;
      border: var(--border);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
      overflow: hidden;
      display: none;
    }
    .chatbot-window.active {
      display: flex;
    }
    .chat-header {
      padding: 15px;
      background: rgba(6,12,26,0.8);
      border-bottom: var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      max-width: 80%;
      padding: 10px 15px;
      border-radius: 18px;
      line-height: 1.4;
    }
    .message.user {
      align-self: flex-end;
      background: var(--ac);
      border-bottom-right-radius: 5px;
    }
    .message.bot {
      align-self: flex-start;
      background: rgba(255,255,255,0.1);
      border-bottom-left-radius: 5px;
    }
    .chat-input {
      display: flex;
      padding: 10px;
      border-top: var(--border);
      background: rgba(6,12,26,0.8);
    }
    .chat-input input {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: var(--border);
      background: rgba(255,255,255,0.1);
      color: var(--txt);
    }
    .chat-input button {
      margin-left: 10px;
      border: none;
      background: var(--ac);
      color: white;
      border-radius: 20px;
      padding: 10px 15px;
      cursor: pointer;
    }
    
    /* Notification Styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(12,20,40,0.95);
      border: var(--border);
      border-radius: 12px;
      padding: 15px;
      max-width: 300px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      z-index: 1000;
      display: none;
    }
    .notification.active {
      display: block;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Mood Tracking */
    .mood-selector {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    .mood-option {
      background: rgba(255,255,255,0.1);
      border: var(--border);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s;
    }
    .mood-option:hover, .mood-option.selected {
      transform: scale(1.2);
      background: var(--ac);
    }

   
  /* Enhanced Chatbot Styles */
  .chatbot-typing {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 3px;
    background: var(--ac);
    opacity: 0.7;
    animation: typingAnimation 1.4s infinite ease-in-out both;
  }
  .chatbot-typing:nth-child(1) { animation-delay: -0.32s; }
  .chatbot-typing:nth-child(2) { animation-delay: -0.16s; }
  @keyframes typingAnimation {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
  }
  .suggestion-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
    padding: 0 10px 10px;
  }
  .suggestion-chip {
    background: rgba(255, 255, 255, 0.1);
    border: var(--border);
    border-radius: 16px;
    padding: 6px 12px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .suggestion-chip:hover {
    background: var(--ac);
    transform: translateY(-2px);
  }

  /* Enhanced Chatbot Styles */
    .chatbot-typing {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 3px;
      background: var(--ac);
      opacity: 0.7;
      animation: typingAnimation 1.4s infinite ease-in-out both;
    }
    .chatbot-typing:nth-child(1) { animation-delay: -0.32s; }
    .chatbot-typing:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typingAnimation {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }
    .suggestion-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      padding: 0 10px 10px;
    }
    .suggestion-chip {
      background: rgba(255, 255, 255, 0.1);
      border: var(--border);
      border-radius: 16px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .suggestion-chip:hover {
      background: var(--ac);
      transform: translateY(-2px);
    }

  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <a class="brand" href="#" onclick="navTo('dashboard')" title="Go to Dashboard">
        <div class="logo">
            <img src="logo.png" alt="Lunora Logo">
        </div>

        <span>Lunora</span>
      </a>
      <nav class="navlinks">
        <button class="navitem active" data-link="dashboard">üè† Dashboard</button>
        <button class="navitem" data-link="profile">üë§ Profile</button>
        <button class="navitem" data-link="journal">üìì Journal</button>
        <button class="navitem" data-link="quests">‚úÖ Tasks</button>
        <button class="navitem" data-link="breathing">üå¨ Breathing</button>
        <button class="navitem" data-link="sos">üö® SOS</button>
      </nav>
      <div class="actions">
        <button class="btn ghost" id="exportBtn">Export Data</button>
        <button class="btn primary" id="breathQuick">Calm Breathing</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- DASHBOARD -->
    <section id="dashboard" data-page class="fade-in active">
      <div class="hero">
        <div class="card p24">
          <div class="pill">AI for Good ‚Ä¢ Mental Wellness</div>
          <h1 class="headline">Hey <span id="helloName">there</span> ‚Äî welcome back to <strong>Lunora</strong></h1>
          <p class="sub">Your gentle space to write, reflect, and build healthy rituals. All data stays in your browser.</p>
          <div class="stats">
            <div class="stat">
              <div class="meta">Points</div>
              <div class="v" id="dPoints">0</div>
            </div>
            <div class="stat">
              <div class="meta">Streak</div>
              <div class="v"><span id="dStreak">0</span> days</div>
            </div>
            <div class="stat">
              <div class="meta">Last Mood</div>
              <div class="v" id="dMood">‚Äî</div>
            </div>
            <div class="stat">
              <div class="meta">Mood Emoji</div>
              <div class="v mood-emoji" id="dMoodEmoji">‚Äî</div>
            </div>
          </div>
          <canvas id="spark" class="spark" aria-label="Mood trend graph"></canvas>
        </div>
        <div class="card p24" style="position:relative">
          <h3 style="margin:0 0 12px">Quick Actions</h3>
          <div class="grid cols-2">
            <div class="tile" onclick="navTo('journal')">
              <div class="icon">üìì</div>
              <div style="font-weight:700">Open Journal</div>
              <div class="meta">Write and get supportive tips</div>
            </div>
            <div class="tile" onclick="openBreathing()">
              <div class="icon">üßò</div>
              <div style="font-weight:700">Start Breathing</div>
              <div class="meta">2‚Äëminute calm exercise</div>
            </div>
            <div class="tile" onclick="navTo('quests')">
              <div class="icon">üéØ</div>
              <div style="font-weight:700">Daily Quests</div>
              <div class="meta">Complete 3 to grow streak</div>
            </div>
            <div class="tile" onclick="navTo('sos')">
              <div class="icon">üö®</div>
              <div style="font-weight:700">SOS & Safety</div>
              <div class="meta">Configure a trusted contact</div>
            </div>
            <div class="tile" onclick="navTo('profile')">
              <div class="icon">üë§</div>
              <div style="font-weight:700">Edit Profile</div>
              <div class="meta">Name, goals, avatar</div>
            </div>
            <div class="tile" onclick="navTo('entries')">
              <div class="icon">üóÇÔ∏è</div>
              <div style="font-weight:700">View Entries</div>
              <div class="meta">See your past notes</div>
            </div>
          </div>
          <!-- Onboarding hint bubble -->
          <div id="hintQA" class="hint" style="display:none; right:16px; top:-8px">Try these quick actions to explore ‚ú®</div>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profile" data-page class="card p24 fade-in">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px">
        <div>
          <h2 style="margin:0 0 6px">Profile</h2>
          <p class="sub">Set up your space. Your info stays on this device.</p>
        </div>
        <button class="btn ghost" onclick="navTo('dashboard')">‚Üê Back to Dashboard</button>
      </div>
      <div style="display:flex; gap:16px; align-items:center; margin-bottom:10px; position:relative">
        <label class="avatar pulse">
          <input id="avatarInput" type="file" accept="image/*" style="display:none">
          <img id="avatarImg" alt="avatar"/>
          <span id="avatarFallback">Add Photo</span>
        </label>
        <button class="btn ghost" onclick="document.getElementById('avatarInput').click()">Upload Avatar</button>
        <div id="hintProfile" class="hint" style="display:none; left:120px; top:-10px">Start here: add your name & contact</div>
      </div>
      <div class="form-row">
        <input class="input" id="name" placeholder="Your name"/>
        <input class="input" id="age" placeholder="Age"/>
      </div>
      <input class="input" id="goals" placeholder="Your wellbeing goal (e.g., reduce stress)"/>
      <div class="form-row">
        <input class="input" id="ecName" placeholder="Emergency contact name"/>
        <input class="input" id="ecMethod" placeholder="Phone or email"/>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px">
        <button class="btn primary" id="saveProfile">Save Profile</button>
        <button class="btn ghost" onclick="navTo('dashboard')">Back to Dashboard</button>
      </div>
      <div id="profileSaved" class="meta" style="margin-top:8px"></div>
    </section>

    <!-- JOURNAL -->
    <section id="journal" data-page class="card p24 fade-in">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px">
        <div>
          <h2 style="margin:0 0 6px">Journal</h2>
          <p class="sub">Write anything on your mind. Lunora highlights cues and suggests gentle steps.</p>
        </div>
        <button class="btn ghost" onclick="navTo('dashboard')">‚Üê Back to Dashboard</button>
      </div>
      
      <!-- Mood Tracking -->
      <div style="margin-bottom: 15px;">
        <p class="meta">How are you feeling today?</p>
        <div class="mood-selector">
          <div class="mood-option" data-mood="1" title="Very Sad">üò¢</div>
          <div class="mood-option" data-mood="2" title="Sad">üòî</div>
          <div class="mood-option" data-mood="3" title="Neutral">üòê</div>
          <div class="mood-option" data-mood="4" title="Good">üôÇ</div>
          <div class="mood-option" data-mood="5" title="Great">üòÑ</div>
        </div>
      </div>
      
      <!-- Journal Book Design -->
      <div class="journal-book">
        <textarea id="journalInput" placeholder="Dear Diary..."></textarea>
      </div>
      
      <div class="journal-toolbar">
        <button class="speech-btn" id="speechBtn" title="Speech to Text">üé§</button>
        <div class="meta"><span id="charCount">0</span> chars ‚Ä¢ <span id="moodScore">Mood: ‚Äî</span></div>
        <div style="display:flex; gap:8px">
          <button class="btn ghost" id="analyzeBtn">Analyze ‚ú®</button>
          <button class="btn primary" id="saveEntryBtn">Save Entry</button>
        </div>
      </div>
      
      <div id="aiOutput" class="grid" style="margin-top:12px"></div>
      <div id="sosInlineBanner" class="sos-banner" style="display:none; margin-top:12px">
        <strong>‚ö†Ô∏è We're concerned.</strong> We detected strong distress language. Consider contacting your emergency person now.
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn primary" onclick="openSOS()">Contact Now</button>
          <button class="btn ghost" onclick="navTo('sos')">Open SOS Page</button>
        </div>
      </div>
      
      <!-- Journal Archive -->
      <div style="margin-top: 30px;">
        <h3>Your Journal Archive</h3>
        <div id="journalArchive" class="journal-archive"></div>
      </div>
    </section>

    <!-- QUESTS -->
    <section id="quests" data-page class="card p24 fade-in">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px">
        <div>
          <h2 style="margin:0 0 6px">Daily Quests</h2>
          <p class="sub">Complete today's 3 cards to grow your streak.</p>
        </div>
        <button class="btn ghost" onclick="navTo('dashboard')">‚Üê Back to Dashboard</button>
      </div>
      <div id="questsList" class="grid"></div>
      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:12px">
        <div class="chip">‚≠ê Points: <span id="points">0</span></div>
        <div class="chip">üî• Streak: <span id="streak">0</span> days</div>
      </div>
      <div id="badges" class="grid" style="margin-top:12px; grid-template-columns:repeat(4, minmax(0,1fr))"></div>
    </section>

    <!-- BREATHING (as its own page trigger + modal player) -->
    <section id="breathing" data-page class="card p24 fade-in">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px">
        <div>
          <h2 style="margin:0 0 6px">Calm Breathing</h2>
          <p class="sub">Follow the ring: Inhale 4s ‚Ä¢ Hold 4s ‚Ä¢ Exhale 6s</p>
        </div>
        <button class="btn ghost" onclick="navTo('dashboard')">‚Üê Back to Dashboard</button>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn primary" onclick="openBreathing()">Start Session</button>
        <button class="btn ghost" onclick="toggleQuest('breathe', true)">Mark Done</button>
      </div>
    </section>

    <!-- SOS -->
    <section id="sos" data-page class="card p24 fade-in">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px">
        <div>
          <h2 style="margin:0 0 6px">Safety & SOS</h2>
          <p class="sub">If Lunora detects high‚Äërisk language, it will nudge you to reach out. You can also contact your person anytime.</p>
        </div>
        <button class="btn ghost" onclick="navTo('dashboard')">‚Üê Back to Dashboard</button>
      </div>
      <div class="sos-banner" id="sosBanner" style="display:none">
        <strong>‚ö†Ô∏è We're concerned.</strong> We detected strong distress language. Consider contacting <span id="contactNameBanner"></span> now, or dial your local emergency number.
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn primary" id="contactNowBtn">Contact Now</button>
          <button class="btn ghost" id="showResourcesBtn">See Resources</button>
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:12px">
        <div class="card p16">
          <h4 style="margin:0 0 8px">Emergency Contact</h4>
          <div class="form-row">
            <input class="input" id="sosName" placeholder="Name"/>
            <input class="input" id="sosMethod" placeholder="Phone or Email"/>
          </div>
          <div style="display:flex; gap:8px; margin-top:10px">
            <button class="btn primary" id="saveContactBtn">Save Contact</button>
            <button class="btn ghost" id="testSOSBtn">Test SOS</button>
          </div>
          <div id="sosTip" class="meta" style="margin-top:8px"></div>
        </div>
        <div class="card p16">
          <h4 style="margin:0 0 8px">Resources</h4>
          <div id="resources" class="meta">
            <p><strong>If you are in immediate danger, call your local emergency number.</strong> This prototype does not replace professional help.</p>
            <ul>
              <li>Talk to a trusted person or counselor.</li>
              <li>Use local or national crisis helplines in your country.</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- ENTRIES -->
    <section id="entries" data-page class="card p24 fade-in">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px">
        <div>
          <h2 style="margin:0 0 6px">Your Entries</h2>
          <p class="sub">Saved locally on this device.</p>
        </div>
        <button class="btn ghost" onclick="navTo('dashboard')">‚Üê Back to Dashboard</button>
      </div>
      <div id="entriesList" class="grid"></div>
    </section>
  </main>

  <footer>
    <div class="container">¬© <span id="year"></span> Lunora ‚Ä¢ Demo prototype ‚Ä¢ All data stays in your browser</div>
  </footer>

  <!-- Breathing Modal -->
  <div class="modal" id="breathModal" aria-hidden="true" role="dialog">
    <div class="panel card p24">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <h3 style="margin:0">Calm Breathing</h3>
        <button class="btn ghost" id="closeBreath">Close</button>
      </div>
      <p class="sub">Follow the ring: Inhale 4s ‚Ä¢ Hold 4s ‚Ä¢ Exhale 6s</p>
      <div style="display:grid; place-items:center; padding:20px">
        <svg id="breathSVG" width="240" height="240" viewBox="0 0 240 240">
          <circle cx="120" cy="120" r="90" stroke="rgba(255,255,255,.2)" stroke-width="10" fill="none"/>
          <circle id="breathAnim" cx="120" cy="120" r="90" stroke="url(#grad)" stroke-width="10" fill="none" stroke-linecap="round" stroke-dasharray="0 1000"/>
          <defs>
            <linearGradient id="grad" x1="0" x2="1">
              <stop offset="0%" stop-color="#5bc0eb"/>
              <stop offset="100%" stop-color="#7aa6ff"/>
            </linearGradient>
          </defs>
        </svg>
      </div>
    </div>
  </div>

  <!-- SOS Compose Modal -->
  <div class="modal" id="sosModal" aria-hidden="true" role="dialog">
    <div class="panel card p24">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <h3 style="margin:0">Contact <span id="dlgSOSName"></span></h3>
        <button class="btn ghost" id="closeSOS">Close</button>
      </div>
      <p class="sub">Copy the message below or open your email app.</p>
      <textarea id="sosMessage" class="journal-area" style="min-height:120px"></textarea>
      <div style="display:flex; gap:8px; margin-top:10px">
        <button class="btn primary" id="copySOS">Copy Message</button>
        <button class="btn ghost" id="emailSOS">Open Email</button>
      </div>
    </div>
  </div>

  <!-- Intro / About Modal -->
  <div class="modal" id="aboutModal" aria-hidden="true" role="dialog">
    <div class="panel card p24">
      <h2 style="margin:0 0 6px">Welcome to Lunora üåô</h2>
      <p class="sub">An AI‚Äëfor‚ÄëGood prototype that supports mental wellness with journaling, gentle insights, healthy habits, and an SOS safety net. All data stays on your device.</p>
      <ul class="meta" style="margin-top:8px">
        <li>Start in <strong>Profile</strong> to save your name and contact.</li>
        <li>Write in <strong>Journal</strong> to get supportive suggestions.</li>
        <li>Complete <strong>Tasks</strong> to earn points and build a streak.</li>
      </ul>
      <div style="display:flex; gap:10px; margin-top:12px">
        <button class="btn primary" id="startNow">Start ‚Äî Create Profile</button>
        <button class="btn ghost" id="closeAbout">Skip for now</button>
      </div>
    </div>
  </div>

<!-- AI Chatbot -->
  <div class="chatbot-container">
    <button class="chatbot-toggle" id="chatbotToggle">üí¨</button>
    <div class="chatbot-window" id="chatbotWindow">
      <div class="chat-header">
        <div style="font-size: 24px;">ü§ñ</div>
        <div>
          <h4 style="margin:0">Luna - Your AI Companion</h4>
          <div class="meta">Here to listen without judgment</div>
        </div>
        <button class="btn ghost" style="margin-left: auto; padding: 4px 8px; font-size: 12px;" id="clearChatBtn">Clear</button>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="message bot">
          Hi there! I'm Luna, your mental wellness companion. How are you feeling today?
        </div>
      </div>
      <div class="suggestion-chips" id="suggestionChips">
        <div class="suggestion-chip" data-msg="I'm feeling great today!">üòä I'm feeling good</div>
        <div class="suggestion-chip" data-msg="I'm a bit anxious">üò∞ I'm anxious</div>
        <div class="suggestion-chip" data-msg="I'm feeling sad">üòî I'm feeling down</div>
        <div class="suggestion-chip" data-msg="I'm stressed about work">üò´ I'm stressed</div>
      </div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Type your message...">
        <button id="sendChatBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px">
      <div style="font-size:20px">üìù</div>
      <h4 style="margin:0">Journal Reminder</h4>
    </div>
    <p style="margin:0">It looks like you haven't journaled today. Writing helps process emotions and track progress!</p>
  </div>

  <div class="confetti" id="confetti"></div>

  <script>
    // ======= Shortcuts =======
    const $ = s=>document.querySelector(s), $$ = s=>Array.from(document.querySelectorAll(s));
    const STORAGE = { 
      entries:'lunora_entries', 
      points:'lunora_points', 
      streak:'lunora_streak', 
      lastQuestDate:'lunora_lastQuestDate', 
      questsState:'lunora_quests', 
      profile:'lunora_profile', 
      avatar:'lunora_avatar', 
      firstRun:'lunora_firstRun',
      lastJournalDate: 'lunora_lastJournalDate',
      chatHistory: 'lunora_chatHistory', 
      moods: 'lunora_moods'
    };
    const todayKey = ()=> new Date().toISOString().slice(0,10);
    const load=(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch(e){return f}};
    const save=(k,v)=>localStorage.setItem(k, JSON.stringify(v));

    // ======= Navigation =======
    function setActiveNav(id){ $$('.navitem').forEach(n=> n.classList.toggle('active', n.dataset.link===id)); }
    function navTo(id){
      $('[data-page].active')?.classList.remove('active');
      document.getElementById(id).classList.add('active');
      setActiveNav(id);
      if(id==='entries') renderEntries();
      if(id==='quests') renderQuests();
      if(id==='journal') { 
        $('#journalInput').focus();
        renderJournalArchive();
        checkJournalReminder();
      }
      if(id==='profile') renderProfile();
      if(id==='sos') renderContact();
    }
    $$('.navitem').forEach(b=> b.addEventListener('click', ()=> navTo(b.dataset.link)));

    // ======= Keyword Sets =======
    const KEYWORDS={
      positive:['grateful','calm','hopeful','excited','proud','joy','happy','relaxed','content','love','progress','improved'],
      negative:['sad','down','anxious','panic','lonely','tired','overwhelmed','stressed','angry','worried','nervous','guilty','ashamed','depressed','worthless','failure','burnt','broken','ill','drained','frustrated'],
      risk:['suicide','suicidal','kill myself','end it','die','don\'t want to live','self-harm','hurt myself','hopeless','no way out','goodbye forever']
    };

    // ======= Dashboard sparkline =======
    function renderSpark(){
      const cvs = $('#spark'); const ctx = cvs.getContext('2d');
      const w = cvs.width = cvs.clientWidth; const h = cvs.height = cvs.clientHeight;
      const entries = load(STORAGE.entries, []);
      const scores = entries.slice(0,20).map(e=> analyzeText(e.text).score).reverse();
      ctx.clearRect(0,0,w,h);
      if(!scores.length) return;
      const min = Math.min(...scores, -6), max = Math.max(...scores, 6);
      const nx = i => i/(scores.length-1||1) * (w-10) + 5;
      const ny = v => h - ((v-min)/(max-min||1)) * (h-10) - 5;
      ctx.lineWidth = 2; ctx.strokeStyle = '#7aa6ff'; ctx.beginPath();
      scores.forEach((v,i)=>{ const x=nx(i), y=ny(v); i?ctx.lineTo(x,y):ctx.moveTo(x,y) });
      ctx.stroke();
    }

    // ======= Profile =======
    function renderProfile(){
      const p = load(STORAGE.profile, {});
      $('#name').value = p.name||''; $('#age').value = p.age||''; $('#goals').value = p.goals||'';
      $('#ecName').value = p.ecName||''; $('#ecMethod').value = p.ecMethod||'';
      const a = localStorage.getItem(STORAGE.avatar);
      if(a){ $('#avatarImg').src = a; $('#avatarImg').style.display='block'; $('#avatarFallback').style.display='none'; }
      else { $('#avatarImg').style.display='none'; $('#avatarFallback').style.display='grid'; }
    }
    $('#avatarInput').addEventListener('change', e=>{
      const file = e.target.files[0]; if(!file) return;
      const rd = new FileReader(); rd.onload = ()=>{ localStorage.setItem(STORAGE.avatar, rd.result); renderProfile(); updateDashboard(); };
      rd.readAsDataURL(file);
    });
    $('#saveProfile').addEventListener('click', ()=>{
      const p={ name:$('#name').value.trim(), age:$('#age').value.trim(), goals:$('#goals').value.trim(), ecName:$('#ecName').value.trim(), ecMethod:$('#ecMethod').value.trim() };
      if(!p.name || !p.ecName || !p.ecMethod){ alert('Please fill name and emergency contact.'); return; }
      save(STORAGE.profile, p); $('#profileSaved').textContent = 'Profile saved ‚úì'; updateDashboard(); toast('Profile saved');
      localStorage.setItem(STORAGE.firstRun, JSON.stringify({done:true}));
    });

    // ======= Journal =======
    const journalInput = $('#journalInput');
    journalInput.addEventListener('input', ()=>{ $('#charCount').textContent = journalInput.value.length; liveRiskCheck(journalInput.value) });
    $('#analyzeBtn').addEventListener('click', ()=> renderAI(journalInput.value));
    $('#saveEntryBtn').addEventListener('click', ()=>{
      const text = journalInput.value.trim(); if(!text){ alert('Write something first.'); return; }
      const selectedMood = $('.mood-option.selected')?.dataset.mood || '3';
      const entry = { id: crypto.randomUUID(), date:new Date().toISOString(), text, mood: selectedMood };
      const entries = load(STORAGE.entries, []); entries.unshift(entry); save(STORAGE.entries, entries);
      
      // Save mood data
      const moods = load(STORAGE.moods, {});
      const today = todayKey();
      moods[today] = selectedMood;
      save(STORAGE.moods, moods);
      
      // Update last journal date
      save(STORAGE.lastJournalDate, todayKey());
      
      renderEntries(); renderAI(text); journalInput.value=''; $('#charCount').textContent=0; toast('Entry saved');
      if(text.length>=120) toggleQuest('journal', true);
      updateDashboard();
      renderJournalArchive();
      
      // Reset mood selection
      $$('.mood-option').forEach(opt => opt.classList.remove('selected'));
    });

    // Mood selection
    $$('.mood-option').forEach(opt => {
      opt.addEventListener('click', () => {
        $$('.mood-option').forEach(o => o.classList.remove('selected'));
        opt.classList.add('selected');
      });
    });

    function analyzeText(text){
      const clean = text.toLowerCase();
      let score=0; let matched={positive:[], negative:[], risk:[]};
      for(const p of KEYWORDS.positive){ if(clean.includes(p)){ score+=2; matched.positive.push(p) } }
      for(const n of KEYWORDS.negative){ if(clean.includes(n)){ score-=2; matched.negative.push(n) } }
      for(const r of KEYWORDS.risk){ if(clean.includes(r)){ score-=6; matched.risk.push(r) } }
      let moodLabel='Neutral', moodColor='var(--muted)';
      if(score>=3){ moodLabel='Positive'; moodColor='var(--good)'; }
      else if(score<=-3){ moodLabel='Low'; moodColor='var(--bad)'; }
      else { moodLabel='Mixed'; moodColor='var(--warn)'; }
      return {score, moodLabel, moodColor, matched};
    }

    function moodEmoji(label){
      return label==='Positive'?'üòä':label==='Low'?'üòî':label==='Mixed'?'üòê':'‚Äî';
    }

    function renderAI(text){
      const out = $('#aiOutput'); out.innerHTML=''; if(!text.trim()) return;
      const {score, moodLabel, moodColor, matched} = analyzeText(text);
      $('#moodScore').textContent = `Mood: ${moodLabel}`; $('#moodScore').style.color=moodColor;

      const chips=[...matched.positive.map(w=>`<span class=\"chip\">üòä ${w}</span>`), ...matched.negative.map(w=>`<span class=\"chip\">üåßÔ∏è ${w}</span>`), ...matched.risk.map(w=>`<span class=\"chip\">‚ö†Ô∏è ${w}</span>`)];
      if(chips.length){ out.insertAdjacentHTML('beforeend', `<div class=\"meta\">Detected cues:</div><div style=\"display:flex;flex-wrap:wrap;gap:6px\">${chips.join('')}</div>`); }

      const tips=[];
      if(matched.risk.length){ tips.push({icon:'üõü',title:'You\'re not alone',body:'Consider talking to someone you trust or a professional. If you\'re in immediate danger, call your local emergency number.'});
        $('#sosBanner').style.display='block'; $('#sosInlineBanner').style.display='block'; const c=load(STORAGE.profile,{}); $('#contactNameBanner').textContent=c.ecName||'your emergency contact'; }
      else { $('#sosBanner').style.display='none'; $('#sosInlineBanner').style.display='none'; }
      if(score<=-3){ tips.push({icon:'üå§Ô∏è',title:'Tiny step now',body:'Try a 2‚Äëminute breathing exercise and write one small action for the next hour.'}); tips.push({icon:'üìì',title:'Reframe prompt',body:'What would you say to a friend feeling this way? Write that to yourself.'}); }
      if(score>=3){ tips.push({icon:'üéØ',title:'Build on this',body:'Pick one health habit quest to complete now to lock in momentum.'}); }
      tips.push({icon:'üíß',title:'Hydration check',body:'Drink a glass of water and notice how you feel.'});

      tips.forEach(t=> out.insertAdjacentHTML('beforeend', `<div class=\"card p16\"><div style=\"display:flex;gap:10px;align-items:flex-start\"><div style=\"font-size:20px\">${t.icon}</div><div><div style=\"font-weight:700;margin-bottom:4px\">${t.title}</div><div class=\"meta\">${t.body}</div></div></div></div>`));
    }

    function liveRiskCheck(text){
      const cleaned = text.toLowerCase();
      const risky = KEYWORDS.risk.some(w=> cleaned.includes(w));
      if(risky){ $('#sosBanner').style.display='block'; $('#sosInlineBanner').style.display='block'; const p=load(STORAGE.profile,{}); $('#contactNameBanner').textContent=p.ecName||'your emergency contact'; }
    }

    // ======= Journal Archive =======
    function renderJournalArchive() {
      const entries = load(STORAGE.entries, []);
      const archive = $('#journalArchive');
      
      if (!entries.length) {
        archive.innerHTML = '<div class="meta">No journal entries yet. Start writing to see them appear here.</div>';
        return;
      }
      
      archive.innerHTML = '';
      entries.slice(0, 6).forEach(entry => {
        const date = new Date(entry.date).toLocaleDateString();
        const preview = entry.text.length > 120 ? entry.text.substring(0, 120) + '...' : entry.text;
        const moodEmojis = ['üò¢', 'üòî', 'üòê', 'üôÇ', 'üòÑ'];
        const moodEmoji = moodEmojis[parseInt(entry.mood || '3') - 1] || 'üòê';
        
        const card = document.createElement('div');
        card.className = 'journal-entry-card';
        card.innerHTML = `
          <h4>${date} ${moodEmoji}</h4>
          <p>${preview}</p>
        `;
        card.addEventListener('click', () => {
          journalInput.value = entry.text;
          $$('.mood-option').forEach(opt => {
            if (opt.dataset.mood === entry.mood) {
              opt.classList.add('selected');
            } else {
              opt.classList.remove('selected');
            }
          });
          window.scrollTo(0, 0);
        });
        archive.appendChild(card);
      });
    }

    // ======= Entries =======
    function renderEntries(){
      const entries = load(STORAGE.entries, []);
      const list = $('#entriesList');
      if(!entries.length){ list.innerHTML = '<div class="meta">No entries yet. Your saved notes will appear here.</div>'; renderSpark(); return; }
      list.innerHTML='';
      for(const e of entries){
        const {moodLabel, moodColor} = analyzeText(e.text);
        const date = new Date(e.date).toLocaleString();
        const card = document.createElement('div'); card.className='card p16';
        card.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
            <div style="display:flex; align-items:center; gap:10px">
              <span class="chip" style="border-color:${moodColor}; color:${moodColor}; background:rgba(255,255,255,.06)">${moodLabel}</span>
              <div class="meta">${date}</div>
            </div>
            <button class="btn ghost" data-del="${e.id}">Delete</button>
          </div>
          <div style="margin-top:8px; white-space:pre-wrap">${escapeHtml(e.text)}</div>`;
        list.appendChild(card);
      }
      $$('#entriesList [data-del]').forEach(btn=> btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-del');
        const entries = load(STORAGE.entries, []).filter(x=>x.id!==id); save(STORAGE.entries, entries); renderEntries(); updateDashboard();
        renderJournalArchive();
      }));
      renderSpark();
    }
    function escapeHtml(s){ return s.replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[m])); }

    // ======= Quests =======
    const QUEST_POOL=[
      {id:'gratitude3', text:'Write 3 things you\'re grateful for', pts:20},
      {id:'walk10', text:'Take a 10‚Äëminute walk', pts:15},
      {id:'water', text:'Drink a full glass of water', pts:10},
      {id:'breathe', text:'Do one 2‚Äëminute breathing session', pts:15},
      {id:'message', text:'Send a kind message to someone', pts:15},
      {id:'journal', text:'Write at least 120 characters in your journal', pts:20},
      {id:'screen', text:'5‚Äëminute screen break', pts:10},
      {id:'stretch', text:'Do light stretching for 3 minutes', pts:10},
    ];
    function getTodayQuests(){
      const last = load(STORAGE.lastQuestDate, null);
      let state = load('lunora_quests', {});
      if(last !== todayKey()){
        const shuffled = [...QUEST_POOL].sort(()=>Math.random()-0.5);
        state = { date: todayKey(), items: shuffled.slice(0,3).map(q=>({...q, done:false})) };
        save('lunora_quests', state); save(STORAGE.lastQuestDate, todayKey());
      }
      return state.items||[];
    }
    function renderQuests(){
      const list=$('#questsList'); list.innerHTML='';
      const items=getTodayQuests();
      for(const q of items){
        const row=document.createElement('label'); row.className='quest';
        row.innerHTML=`<input type="checkbox" ${q.done?'checked':''} data-quest="${q.id}"> <div><div>${q.text}</div><div class="meta">${q.pts} pts</div></div>`;
        list.appendChild(row);
      }
      $$('#questsList [data-quest]').forEach(cb=> cb.addEventListener('change', ()=> toggleQuest(cb.getAttribute('data-quest'), cb.checked)));
      updatePoints(); updateStreak(); renderBadges();
    }
    function toggleQuest(id, done){
      const state = load('lunora_quests', {items:[]});
      const item = state.items.find(x=>x.id===id);
      if(item){ item.done = done; save('lunora_quests', state); }
      if(done){ const pts = load(STORAGE.points, 0) + (item?.pts||0); save(STORAGE.points, pts); dropConfetti(); }
      else { const pts = Math.max(0, load(STORAGE.points, 0) - (item?.pts||0)); save(STORAGE.points, pts); }
      updatePoints();
      if(state.items.every(x=>x.done)){
        const last=load(STORAGE.lastQuestDate, todayKey());
        if(last===todayKey()){ const s=load(STORAGE.streak,0)+1; save(STORAGE.streak,s); toast('Daily quests complete! Streak +1 üî•'); save(STORAGE.lastQuestDate,'completed-'+todayKey()); renderBadges(); }
      }
      updateDashboard();
    }
    const updatePoints=()=> $('#points').textContent = load(STORAGE.points,0);
    const updateStreak=()=> $('#streak').textContent = load(STORAGE.streak,0);
    function renderBadges(){
      const s=load(STORAGE.streak,0), p=load(STORAGE.points,0);
      const wrap=$('#badges'); wrap.innerHTML='';
      const badges=[]; if(s>=1) badges.push({icon:'üå±',label:'Day 1'}); if(s>=3) badges.push({icon:'üéñÔ∏è',label:'3‚ÄëDay'}); if(s>=7) badges.push({icon:'üèÜ',label:'1‚ÄëWeek'}); if(p>=100) badges.push({icon:'üí´',label:'100+'});
      badges.forEach(b=>{ const el=document.createElement('div'); el.className='chip'; el.innerHTML=`<span style="font-size:18px">${b.icon}</span> ${b.label}`; wrap.appendChild(el); })
    }

    // ======= SOS =======
    function renderContact(){
      const p=load(STORAGE.profile,{});
      if(p.ecName && p.ecMethod){ $('#sosTip').textContent = `Saved: ${p.ecName} (${p.ecMethod})`; $('#sosName').value=p.ecName; $('#sosMethod').value=p.ecMethod; } else { $('#sosTip').textContent='Add a trusted person (phone or email).'; }
    }
    $('#saveContactBtn').addEventListener('click', ()=>{
      const p=load(STORAGE.profile,{}); p.ecName=$('#sosName').value.trim(); p.ecMethod=$('#sosMethod').value.trim();
      if(!p.ecName || !p.ecMethod){ alert('Please enter name and phone/email.'); return; }
      save(STORAGE.profile,p); renderContact(); toast('Contact saved'); updateDashboard();
    });
    $('#testSOSBtn').addEventListener('click', ()=> openSOS('This is a test message from Lunora to check SOS.'));
    function openSOS(prefill){
      const p=load(STORAGE.profile,{}); if(!p.ecName||!p.ecMethod){ alert('Please add an emergency contact first.'); return; }
      $('#dlgSOSName').textContent = p.ecName;
      const msg = `${p.ecName},

I\'m using Lunora and I may need support right now. Could you please check in with me?

Message generated at ${new Date().toLocaleString()}.`;
      $('#sosMessage').value = prefill || msg; $('#sosModal').classList.add('active');
    }
    $('#closeSOS').addEventListener('click', ()=> $('#sosModal').classList.remove('active'));
    $('#copySOS').addEventListener('click', async ()=>{ await navigator.clipboard.writeText($('#sosMessage').value); toast('Copied to clipboard'); });
    $('#emailSOS').addEventListener('click', ()=>{
      const p=load(STORAGE.profile,{}); if(!p.ecMethod) return; const subject=encodeURIComponent('Checking in on me'); const body=encodeURIComponent($('#sosMessage').value);
      window.location.href=`mailto:${encodeURIComponent(p.ecMethod)}?subject=${subject}&body=${body}`;
    });
    $('#contactNowBtn').addEventListener('click', ()=> openSOS());
    $('#showResourcesBtn').addEventListener('click', ()=> $('#resources').scrollIntoView({behavior:'smooth'}));

    // ======= Breathing =======
    const breath={ running:false, t:0,
      open(){ $('#breathModal').classList.add('active'); this.running=true; this.t=0; this.loop(); },
      close(){ $('#breathModal').classList.remove('active'); this.running=false; },
      loop(){ if(!this.running) return; this.t+=16; const cycle=14000; const phase=this.t%cycle; let frac; if(phase<4000) frac=phase/4000; else if(phase<8000) frac=1; else frac=1-(phase-8000)/6000; const len=2*Math.PI*90; const dash=len*frac; $('#breathAnim').setAttribute('stroke-dasharray', `${dash} ${1000}`); requestAnimationFrame(()=>this.loop()); }
    };
    function openBreathing(){ breath.open(); toggleQuest('breathe', true); }
    $('#breathQuick').addEventListener('click', openBreathing);
    $('#closeBreath').addEventListener('click', ()=> breath.close());

    // ======= Export =======
    $('#exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify({profile:load(STORAGE.profile,{}), entries:load(STORAGE.entries,[]), points:load(STORAGE.points,0), streak:load(STORAGE.streak,0)}, null, 2)], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`lunora-data-${todayKey()}.json`; a.click();
    });

    // ======= Confetti & Toast =======
    function dropConfetti(){ const wrap=$('#confetti'); Array.from({length:24}).forEach(()=>{ const s=document.createElement('span'); s.textContent=['‚ú®','üéâ','üíô','‚≠ê','ü´ß'][Math.floor(Math.random()*5)]; s.style.position='absolute'; s.style.left=Math.random()*100+'vw'; s.style.top='-10vh'; s.style.transform=`rotate(${Math.random()*360}deg)`; wrap.appendChild(s); const d=2000+Math.random()*1500; s.animate([{transform:'translateY(-10vh) rotate(0deg)'},{transform:`translateY(110vh) rotate(${180+Math.random()*360}deg)`}],{duration:d, easing:'cubic-bezier(.2,.6,.2,1)'}).finished.then(()=> s.remove()); }); }
    function toast(msg){ const t=document.createElement('div'); t.textContent=msg; t.style.position='fixed'; t.style.bottom='20px'; t.style.left='50%'; t.style.transform='translateX(-50%)'; t.style.background='rgba(12,20,40,.92)'; t.style.border='var(--border)'; t.style.padding='10px 14px'; t.style.borderRadius='12px'; t.style.zIndex='200'; document.body.appendChild(t); setTimeout(()=>{ t.animate([{opacity:1},{opacity:0}],{duration:420}).finished.then(()=> t.remove()) }, 1400); }

    // ======= Dashboard sync =======
    function updateDashboard(){
      const p=load(STORAGE.profile,{}); $('#helloName').textContent = p.name? p.name : 'there';
      $('#dPoints').textContent = load(STORAGE.points,0); $('#dStreak').textContent = load(STORAGE.streak,0);
      const entries=load(STORAGE.entries,[]); const last=entries[0]; if(last){ const {moodLabel}=analyzeText(last.text); $('#dMood').textContent=moodLabel; $('#dMoodEmoji').textContent=moodEmoji(moodLabel); } else { $('#dMood').textContent='‚Äî'; $('#dMoodEmoji').textContent='‚Äî'; }
      renderSpark(); renderContact();
    }

    // ======= Onboarding (About + Hints) =======
    function maybeShowIntro(){
      const run = load(STORAGE.firstRun, null);
      if(!run){ $('#aboutModal').classList.add('active'); setTimeout(()=>{ $('#hintProfile').style.display='block'; $('#hintQA').style.display='block'; }, 600); }
    }
    $('#startNow').addEventListener('click', ()=>{ $('#aboutModal').classList.remove('active'); navTo('profile'); localStorage.setItem(STORAGE.firstRun, JSON.stringify({done:true})); });
    $('#closeAbout').addEventListener('click', ()=>{ $('#aboutModal').classList.remove('active'); localStorage.setItem(STORAGE.firstRun, JSON.stringify({done:true})); });

    // ======= Speech to Text =======
    let recognition = null;
    $('#speechBtn').addEventListener('click', toggleSpeechRecognition);

    function toggleSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        alert("Speech recognition is not supported in this browser.");
        return;
      }
      
      if (!recognition) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'en-US';
        
        recognition.onstart = () => {
          $('#speechBtn').classList.add('recording');
          $('#speechBtn').title = "Stop Recording";
        };
        
        recognition.onresult = (event) => {
          let transcript = '';
          for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
              transcript += event.results[i][0].transcript;
            }
          }
          
          if (transcript) {
            journalInput.value += transcript + ' ';
            $('#charCount').textContent = journalInput.value.length;
          }
        };
        
        recognition.onend = () => {
          $('#speechBtn').classList.remove('recording');
          $('#speechBtn').title = "Speech to Text";
        };
        
        recognition.onerror = (event) => {
          console.error('Speech recognition error', event.error);
          $('#speechBtn').classList.remove('recording');
          $('#speechBtn').title = "Speech to Text";
        };
      }
      
      if ($('#speechBtn').classList.contains('recording')) {
        recognition.stop();
      } else {
        recognition.start();
      }
    }

    // ======= Journal Reminder System =======
    function checkJournalReminder() {
      const lastJournalDate = load(STORAGE.lastJournalDate, '');
      const today = todayKey();
      
      if (lastJournalDate !== today) {
        // Check if it's later in the day (after 6 PM)
        const now = new Date();
        if (now.getHours() >= 18) {
          // Show reminder notification
          showNotification();
        }
      }
    }
    
    function showNotification() {
      const notification = $('#notification');
      notification.classList.add('active');
      
      setTimeout(() => {
        notification.classList.remove('active');
      }, 5000);
    }

    // ======= Mood Tracking =======
    function trackMood(moodValue) {
      const moods = load(STORAGE.moods, {});
      const today = todayKey();
      moods[today] = moodValue;
      save(STORAGE.moods, moods);
    }

    // ======= Enhanced AI Chatbot =======
    // Emotional analysis keywords
    const EMOTION_KEYWORDS = {
      happy: ['happy', 'good', 'great', 'excited', 'joy', 'joyful', 'wonderful', 'amazing', 'fantastic', 'better', 'relieved', 'proud', 'grateful', 'thankful', 'content', 'peaceful', 'optimistic', 'hopeful', 'cheerful'],
      sad: ['sad', 'depressed', 'unhappy', 'miserable', 'hopeless', 'tearful', 'down', 'low', 'blue', 'grief', 'heartbroken', 'disappointed', 'hurt', 'sorrow', 'melancholy', 'despair', 'gloomy'],
      anxious: ['anxious', 'nervous', 'worried', 'stressed', 'panic', 'overwhelmed', 'tense', 'uneasy', 'apprehensive', 'fear', 'scared', 'afraid', 'dread', 'panic', 'worrisome', 'restless', 'jittery'],
      angry: ['angry', 'mad', 'furious', 'irritated', 'annoyed', 'frustrated', 'resentful', 'outraged', 'bitter', 'hostile', 'agitated', 'irked', 'livid', 'fuming'],
      tired: ['tired', 'exhausted', 'fatigued', 'weary', 'drained', 'burned out', 'sleepy', 'lethargic', 'spent', 'worn out', 'run down', 'sleep-deprived'],
      lonely: ['lonely', 'alone', 'isolated', 'abandoned', 'empty', 'unwanted', 'disconnected', 'secluded', 'forsaken', 'left out'],
      confused: ['confused', 'uncertain', 'unsure', 'indecisive', 'perplexed', 'puzzled', 'bewildered', 'disoriented', 'lost', 'torn'],
      motivated: ['motivated', 'determined', 'focused', 'driven', 'inspired', 'ambitious', 'energized', 'purposeful', 'committed']
    };

    // Contextual memory for conversation flow
    let conversationContext = {
      currentTopic: '',
      emotionalState: '',
      mentionedIssues: [],
      lastResponseType: '',
      userName: ''
    };

    // Response templates with more variety and depth
    const RESPONSE_TEMPLATES = {
      greeting: [
        "Hi there! How are you feeling today?",
        "Hello! It's good to see you. How has your day been?",
        "Hey! I'm here to listen. What's on your mind?",
        "Hi! How are things going for you today?"
      ],
      happy: [
        "That's wonderful to hear! üòä What's contributing to these positive feelings?",
        "I'm so glad you're feeling good! üåü Would you like to share what's making you happy?",
        "It's great that you're in a positive space! Would you like to do a quick gratitude exercise to amplify these feelings?",
        "Happy to hear you're doing well! Remember to savor these positive moments. What's been going well for you?"
      ],
      sad: [
        "I'm sorry to hear you're feeling down. üòî Would you like to talk more about what's going on?",
        "It sounds like you're having a tough time. I'm here to listen without judgment. What's on your mind?",
        "Thank you for sharing that with me. It takes courage to acknowledge when we're feeling low. Would a breathing exercise help right now?",
        "I hear you. Sometimes just putting these feelings into words can help. Would you like to continue sharing?"
      ],
      anxious: [
        "It sounds like you're feeling some anxiety. üò∞ Would you like to try a quick grounding exercise together?",
        "I understand that anxious feeling. Let's take a moment to breathe. Would you like to share what's specifically worrying you?",
        "Anxiety can be really challenging. Remember that these feelings are temporary. What's one small thing that might help you feel a bit calmer?",
        "Thank you for naming that anxiety. Sometimes just identifying it can reduce its power. Would you like to talk through what's triggering these feelings?"
      ],
      angry: [
        "It sounds like you're feeling some strong emotions. üò† Would you like to talk about what's causing these feelings?",
        "Anger is a valid emotion that often signals when our boundaries have been crossed. Want to explore what might be behind these feelings?",
        "I hear your frustration. Sometimes writing about what's making us angry can help process it. Would you like to try that?",
        "It's okay to feel angry. What's one healthy way you might channel this energy?"
      ],
      tired: [
        "It sounds like you're feeling drained. üò¥ Have you been able to get enough rest recently?",
        "I hear that exhaustion. Sometimes we need to give ourselves permission to rest. What's one small way you could practice self-care today?",
        "Fatigue can really impact our mental health. Have you noticed any patterns to when you feel most tired?",
        "Being tired makes everything harder. What's one thing that usually helps you recharge, even a little?"
      ],
      lonely: [
        "I hear that loneliness. üòî Connection is a fundamental human need. Is there someone you might reach out to today, even briefly?",
        "Loneliness can be really painful. Remember that many people experience this, especially nowadays. Would you like to talk about what kind of connection you're missing?",
        "Thank you for sharing that. Would you like to try a journaling exercise about relationships and connection?",
        "I'm here with you. Sometimes acknowledging the loneliness can lessen its intensity. What does connection look like for you?"
      ],
      confused: [
        "It sounds like you're feeling uncertain. ü§î Would it help to talk through the options you're considering?",
        "Feeling confused or indecisive is completely normal. Sometimes listing pros and cons can bring clarity. Would you like to try that?",
        "I understand that feeling of being unsure. What aspects are you most conflicted about?",
        "It's okay not to have all the answers right now. What's one small step you could take to gain more clarity?"
      ],
      motivated: [
        "That's fantastic! üòÉ Having motivation can be such a powerful force. What are you feeling inspired to do?",
        "It's great to hear you're feeling motivated! What's sparked this energy?",
        "I love hearing about your motivation! How can you harness this energy to work toward your goals?",
        "That drive and determination is wonderful to see! What's your plan for channeling this motivation?"
      ],
      neutral: [
        "Thanks for sharing. Would you like to talk more about what's going on?",
        "I appreciate you checking in. Is there anything specific you'd like to discuss today?",
        "How has your week been so far?",
        "Is there anything on your mind that you'd like to explore together?"
      ],
      supportive: [
        "Remember to be kind to yourself today. You're doing the best you can. üíô",
        "It's okay to not have all the answers. Taking things one step at a time is enough.",
        "Whatever you're feeling is valid. Your emotions are information, not instructions.",
        "You're not alone in this. I'm here to support you however I can.",
        "Progress isn't always linear. It's okay to have ups and downs."
      ],
      resources: [
        "Would you like me to suggest a quick mindfulness exercise?",
        "I can guide you through a breathing technique if that might help.",
        "Sometimes writing in your journal can help process these feelings. Would you like to try that?",
        "Would a gratitude practice be helpful right now?",
        "Would you like to try a quick grounding exercise to help you feel more present?"
      ],
      followUp: [
        "How does that make you feel?",
        "What do you think about that?",
        "Can you tell me more about that?",
        "What else is coming up for you as we talk about this?",
        "How long have you been feeling this way?"
      ],
      checkIn: [
        "How are you feeling now after talking about this?",
        "What's coming up for you as we discuss this?",
        "Does putting this into words help at all?",
        "What part of this feels most significant to you?"
      ]
    };

    // Mental health resources and techniques
    const MENTAL_HEALTH_RESOURCES = {
      breathing: {
        name: "Box Breathing",
        steps: "Inhale for 4 counts, hold for 4 counts, exhale for 4 counts, hold for 4 counts. Repeat 4 times.",
        prompt: "Would you like to try a quick breathing exercise together?"
      },
      grounding: {
        name: "5-4-3-2-1 Grounding",
        steps: "Name 5 things you can see, 4 things you can feel, 3 things you can hear, 2 things you can smell, and 1 thing you can taste.",
        prompt: "Would you like to try a grounding exercise to help you feel more present?"
      },
      journaling: {
        name: "Journaling Prompt",
        steps: "Write about what you're feeling without judgment. Try completing this sentence: 'Right now, I feel...'",
        prompt: "Would you like to try a journaling exercise to process these feelings?"
      },
      gratitude: {
        name: "Three Good Things",
        steps: "Name three things you're grateful for today, no matter how small.",
        prompt: "Would a gratitude practice be helpful right now?"
      }
    };

    // Initialize chatbot with enhanced functionality
    function initChatbot() {
      // Load chat history
      const chatHistory = load(STORAGE.chatHistory, []);
      const chatMessages = $('#chatMessages');
      
      // Only restore history if it's from today
      const today = todayKey();
      const todayHistory = chatHistory.filter(msg => msg.timestamp.startsWith(today));
      
      // Load user profile for personalization
      const profile = load(STORAGE.profile, {});
      if (profile.name) {
        conversationContext.userName = profile.name;
      }
      
      if (todayHistory.length > 0) {
        chatMessages.innerHTML = '';
        todayHistory.forEach(msg => {
          addMessageToChat(msg.message, msg.sender, false);
        });
        
        // Analyze last conversation for context
        if (todayHistory.length > 2) {
          const lastUserMessage = todayHistory.filter(msg => msg.sender === 'user').pop();
          if (lastUserMessage) {
            const emotionAnalysis = analyzeEmotion(lastUserMessage.message);
            conversationContext.emotionalState = emotionAnalysis.dominant;
          }
        }
      } else {
        // Add personalized welcome message
        const welcomeMessage = conversationContext.userName 
          ? `Hi ${conversationContext.userName}! I'm Luna, your mental wellness companion. How are you feeling today?`
          : "Hi there! I'm Luna, your mental wellness companion. How are you feeling today?";
        
        addMessageToChat(welcomeMessage, 'bot', false);
      }
      
      // Setup event listeners
      $('#sendChatBtn').addEventListener('click', sendChatMessage);
      $('#chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChatMessage();
      });
      
      // Suggestion chips with more relevant options
      updateSuggestionChips();
      
      // Clear chat button
      $('#clearChatBtn').addEventListener('click', () => {
        if (confirm("Clear all chat history?")) {
          $('#chatMessages').innerHTML = '';
          save(STORAGE.chatHistory, []);
          addMessageToChat("Chat cleared. How are you feeling today?", 'bot', true);
          conversationContext = {
            currentTopic: '',
            emotionalState: '',
            mentionedIssues: [],
            lastResponseType: '',
            userName: conversationContext.userName
          };
        }
      });
    }

    // Enhanced emotional analysis with context awareness
    function analyzeEmotion(text) {
      const cleanText = text.toLowerCase();
      const emotions = {
        happy: 0,
        sad: 0,
        anxious: 0,
        angry: 0,
        tired: 0,
        lonely: 0,
        confused: 0,
        motivated: 0
      };
      
      // Count emotion keywords with weighting
      for (const [emotion, keywords] of Object.entries(EMOTION_KEYWORDS)) {
        emotions[emotion] = keywords.filter(word => {
          const regex = new RegExp(`\\b${word}\\b`, 'i');
          return regex.test(cleanText);
        }).length;
      }
      
      // Detect emotional intensity through modifiers
      const intensityModifiers = {
        very: 2, really: 2, extremely: 3, incredibly: 3, 
        somewhat: 0.5, slightly: 0.5, aBit: 0.5, kindOf: 0.5
      };
      
      for (const [modifier, weight] of Object.entries(intensityModifiers)) {
        if (cleanText.includes(modifier)) {
          for (const emotion in emotions) {
            emotions[emotion] *= weight;
          }
        }
      }
      
      // Detect negation patterns
      const negationPattern = /\b(not|never|no|don't|can't|won't|nobody|nothing|nowhere|neither|never|hardly|scarcely|barely)\b/;
      if (negationPattern.test(cleanText)) {
        emotions.sad += 2;
        emotions.anxious += 1;
      }
      
      // Detect positive language
      const positivePattern = /\b(yes|good|great|love|wonderful|awesome|excellent|perfect|nice|happy|joy|pleasure|delight)\b/;
      if (positivePattern.test(cleanText)) {
        emotions.happy += 2;
      }
      
      // Detect question patterns
      const questionPattern = /\?/;
      const isQuestion = questionPattern.test(cleanText);
      
      // Find dominant emotion
      let dominantEmotion = 'neutral';
      let maxScore = 0;
      
      for (const [emotion, score] of Object.entries(emotions)) {
        if (score > maxScore) {
          maxScore = score;
          dominantEmotion = emotion;
        }
      }
      
      // If it's a question but no strong emotion detected
      if (maxScore === 0 && isQuestion) {
        dominantEmotion = 'question';
      }
      
      return {
        emotions,
        dominant: maxScore > 0 ? dominantEmotion : 'neutral',
        intensity: maxScore,
        isQuestion: isQuestion
      };
    }

    // Update suggestion chips based on context
    function updateSuggestionChips() {
      const chipsContainer = $('#suggestionChips');
      chipsContainer.innerHTML = '';
      
      let suggestions = [];
      
      if (conversationContext.emotionalState) {
        // Contextual suggestions based on emotional state
        switch(conversationContext.emotionalState) {
          case 'sad':
            suggestions = [
              {msg: "I've been feeling really down lately", text: "üòî I've been feeling down"},
              {msg: "Nothing seems to make me happy anymore", text: "üòû Nothing makes me happy"},
              {msg: "I just need someone to talk to", text: "üí¨ I need to talk"}
            ];
            break;
          case 'anxious':
            suggestions = [
              {msg: "I'm feeling really anxious about everything", text: "üò∞ I'm feeling anxious"},
              {msg: "I can't stop worrying", text: "üò£ I can't stop worrying"},
              {msg: "I need help calming down", text: "üßò Help me calm down"}
            ];
            break;
          case 'angry':
            suggestions = [
              {msg: "I'm so frustrated with everything", text: "üò† I'm frustrated"},
              {msg: "I don't know how to handle my anger", text: "üî• Handling anger"},
              {msg: "Everything is making me irritated", text: "‚ö° Everything irritates me"}
            ];
            break;
          default:
            suggestions = [
              {msg: "I'm feeling great today!", text: "üòä I'm feeling good"},
              {msg: "I'm a bit anxious", text: "üò∞ I'm anxious"},
              {msg: "I'm feeling sad", text: "üòî I'm feeling down"},
              {msg: "I'm stressed about work", text: "üò´ I'm stressed"}
            ];
        }
      } else {
        // Default suggestions
        suggestions = [
          {msg: "I'm feeling great today!", text: "üòä I'm feeling good"},
          {msg: "I'm a bit anxious", text: "üò∞ I'm anxious"},
          {msg: "I'm feeling sad", text: "üòî I'm feeling down"},
          {msg: "I'm stressed about work", text: "üò´ I'm stressed"}
        ];
      }
      
      // Add suggestion chips
      suggestions.forEach(suggestion => {
        const chip = document.createElement('div');
        chip.className = 'suggestion-chip';
        chip.setAttribute('data-msg', suggestion.msg);
        chip.textContent = suggestion.text;
        chip.addEventListener('click', () => {
          $('#chatInput').value = chip.getAttribute('data-msg');
          sendChatMessage();
        });
        chipsContainer.appendChild(chip);
      });
    }

    // Enhanced response generation with context awareness
    function generateResponse(userMessage, emotionAnalysis) {
      const { dominant, intensity, isQuestion } = emotionAnalysis;
      let responses = [];
      
      // Update conversation context
      conversationContext.emotionalState = dominant;
      conversationContext.lastResponseType = 'emotional';
      
      // Check for specific mental health concerns that need careful handling
      const riskKeywords = KEYWORDS.risk;
      const hasRiskLanguage = riskKeywords.some(word => userMessage.toLowerCase().includes(word));
      
      if (hasRiskLanguage) {
        // Handle crisis language with care
        const profile = load(STORAGE.profile, {});
        const contactName = profile.ecName || 'someone you trust';
        
        responses.push("I'm really concerned about what you're sharing. It sounds like you're in significant pain.");
        responses.push(`Please consider reaching out to ${contactName} or a mental health professional right now.`);
        responses.push("You don't have to go through this alone. There are people who want to help.");
        
        // Show SOS resources
        $('#sosBanner').style.display = 'block';
        $('#sosInlineBanner').style.display = 'block';
        $('#contactNameBanner').textContent = contactName;
        
        return responses.join(' ');
      }
      
      // Add emotion-specific response
      if (RESPONSE_TEMPLATES[dominant]) {
        const emotionResponse = RESPONSE_TEMPLATES[dominant][
          Math.floor(Math.random() * RESPONSE_TEMPLATES[dominant].length)
        ];
        responses.push(emotionResponse);
      }
      
      // For stronger emotions, add a supportive message
      if (intensity > 1 && !['happy', 'motivated', 'neutral'].includes(dominant)) {
        const supportiveResponse = RESPONSE_TEMPLATES.supportive[
          Math.floor(Math.random() * RESPONSE_TEMPLATES.supportive.length)
        ];
        responses.push(supportiveResponse);
      }
      
      // Add a resource suggestion for moderate to strong emotions
      if (intensity > 0 && !['happy', 'motivated'].includes(dominant)) {
        // Select appropriate resource based on emotional state
        let resourceType;
        switch(dominant) {
          case 'anxious':
            resourceType = Math.random() > 0.5 ? 'breathing' : 'grounding';
            break;
          case 'sad':
          case 'lonely':
            resourceType = Math.random() > 0.5 ? 'journaling' : 'gratitude';
            break;
          default:
            resourceType = ['breathing', 'grounding', 'journaling', 'gratitude'][
              Math.floor(Math.random() * 4)
            ];
        }
        
        responses.push(MENTAL_HEALTH_RESOURCES[resourceType].prompt);
        conversationContext.lastResponseType = 'resource';
        conversationContext.currentTopic = resourceType;
      }
      
      // Add follow-up question for deeper exploration
      if (intensity > 0 && Math.random() > 0.3) {
        const followUp = RESPONSE_TEMPLATES.followUp[
          Math.floor(Math.random() * RESPONSE_TEMPLATES.followUp.length)
        ];
        responses.push(followUp);
        conversationContext.lastResponseType = 'followUp';
      }
      
      // Default response if nothing else applies
      if (responses.length === 0) {
        responses.push(RESPONSE_TEMPLATES.neutral[
          Math.floor(Math.random() * RESPONSE_TEMPLATES.neutral.length)
        ]);
      }
      
      return responses.join(' ');
    }

    // Enhanced send message function
    function sendChatMessage() {
      const input = $('#chatInput');
      const message = input.value.trim();
      if (!message) return;
      
      // Add user message to chat
      addMessageToChat(message, 'user');
      input.value = '';
      
      // Show typing indicator
      const typingIndicator = document.createElement('div');
      typingIndicator.className = 'message bot';
      typingIndicator.id = 'typingIndicator';
      typingIndicator.innerHTML = `
        <div style="display:flex; align-items:center;">
          <div class="chatbot-typing"></div>
          <div class="chatbot-typing"></div>
          <div class="chatbot-typing"></div>
        </div>
      `;
      $('#chatMessages').appendChild(typingIndicator);
      $('#chatMessages').scrollTop = $('#chatMessages').scrollHeight;
      
      // Analyze emotion and generate response (with variable delay to simulate thinking)
      const delay = 1000 + Math.random() * 1000; // Between 1-2 seconds
      
      setTimeout(() => {
        const emotionAnalysis = analyzeEmotion(message);
        const response = generateResponse(message, emotionAnalysis);
        
        // Remove typing indicator
        const indicator = $('#typingIndicator');
        if (indicator) indicator.remove();
        
        // Add response to chat
        addMessageToChat(response, 'bot');
        
        // Update suggestion chips based on new context
        updateSuggestionChips();
      }, delay);
    }

    // Enhanced add message function
    function addMessageToChat(message, sender, saveToHistory = true) {
      const chatMessages = $('#chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      messageDiv.textContent = message;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // Save to chat history
      if (saveToHistory) {
        const chatHistory = load(STORAGE.chatHistory, []);
        chatHistory.push({ 
          sender, 
          message, 
          timestamp: new Date().toISOString() 
        });
        save(STORAGE.chatHistory, chatHistory);
      }
    }

    // ======= Init =======
    const year = new Date().getFullYear(); $('#year').textContent=year;
    renderProfile(); renderEntries(); renderQuests(); updateDashboard(); maybeShowIntro();
    renderJournalArchive();

    initChatbot();

  // ADD THIS CODE - Chatbot toggle functionality
  $('#chatbotToggle').addEventListener('click', () => {
    $('#chatbotWindow').classList.toggle('active');
  });

  // Analyze as user pauses
  let timer; journalInput.addEventListener('input', ()=>{ clearTimeout(timer); timer=setTimeout(()=> renderAI(journalInput.value), 600); });

  // Resize sparkline on window resize
  addEventListener('resize', renderSpark);
</script>

    
  </script>
</body>
</html>
